<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LEXIMAX</title>
    <link rel="icon" type="image/png" href="favicon_L_top_highres.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            limit, 
            onSnapshot,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7MGy-7Gh5h1zp6KjuDq2_pRekPvCHrM4",
            authDomain: "leximax-96299.firebaseapp.com",
            projectId: "leximax-96299",
            storageBucket: "leximax-96299.appspot.com",
            messagingSenderId: "1067424610925",
            appId: "1:1067424610925:web:f2d344a474e9bad8b8dd64"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function getGameIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('gameId');
        }

        window.firebaseOps = {
            async getGameData() {
                try {
                    let gameId = getGameIdFromUrl();
                    if (!gameId) {
                        const gamesRef = collection(db, 'daily_games');
                        const q = query(gamesRef, orderBy('createdAt', 'desc'), limit(1));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            gameId = querySnapshot.docs[0].id;
                        } else {
                            console.error("No games found");
                            return null;
                        }
                    }
                    console.log("Looking for game:", gameId);
                    const gameDoc = await getDoc(doc(db, 'daily_games', gameId));
                    if (!gameDoc.exists()) {
                        console.error("No game found for:", gameId);
                        return null;
                    }
                    return {
                        id: gameId,
                        ...gameDoc.data()
                    };
                } catch (error) {
                    console.error("Error fetching game data:", error);
                    return null;
                }
            },
            
            async addLeaderboardEntry(gameId, name, time) {
                try {
                    const entry = {
                        name: String(name).slice(0, 12),
                        time: Number(time),
                        timestamp: new Date().toISOString()
                    };
                    await addDoc(collection(db, 'daily_games', gameId, 'leaderboard'), entry);
                    return true;
                } catch (error) {
                    console.error("Error adding leaderboard entry:", error);
                    return false;
                }
            }
        };

        window.formatTime = function(seconds) {
            if (!seconds && seconds !== 0) return '--:--';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        };
    </script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        .game-wrapper {
            width: 100%;
            max-width: 320px;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            overflow: hidden;
        }

        #leximax-title {
            display: flex;
            gap: 0;
            margin-bottom: 8px;
        }

        .title-block {
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 35px;
            font-weight: bold;
            color: white;
        }

        #target-word-container {
            text-align: center;
            margin-bottom: 8px;
        }

        #target-word-label {
            font-size: 22px;
            margin-bottom: 4px;
            font-weight: bold;
            color: #666666;
        }

        #target-word {
            display: flex;
            gap: 1px;
            justify-content: center;
            background-color: white;
            padding: 1px;
            border: 1px solid #004d40;
        }

        .target-letter {
            width: 25px;
            height: 25px;
            background-color: #004d40;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* ✅ Footer Styling */
        footer {
            background-color: #004d40;
            color: #FFFFFF;
            text-align: center;
            padding: 20px 0;
            font-size: 14px;
            margin-top: 40px;
        }

        footer a {
            color: #FFC107;
            text-decoration: none;
            margin: 0 12px;
            font-weight: bold;
            font-size: 14px;
        }

        footer a:hover {
            text-decoration: underline;
        }

        footer p {
            margin-top: 10px;
            font-size: 12px;
        }

        /* ✅ Buy Me A Coffee Button Styling */
        .coffee-button {
            text-align: center;
            margin: 30px auto;
        }

        #bmc-wbtn {
            display: inline-block;
            font-size: 14px !important;
            padding: 8px 16px !important;
            border-radius: 4px !important;
            font-family: 'Arial', sans-serif !important;
        }

        /* ✅ Add Space Between Content and Footer */
        .game-wrapper {
            margin-bottom: 40px;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <!-- ✅ Game Title -->
        <div id="leximax-title">
            <div class="title-block" style="background-color: #2196f3;">L</div>
            <div class="title-block" style="background-color: #f44336;">E</div>
            <div class="title-block" style="background-color: #4caf50;">X</div>
            <div class="title-block" style="background-color: #ffc107;">I</div>
            <div class="title-block" style="background-color: #9c27b0;">M</div>
            <div class="title-block" style="background-color: #0066FF;">A</div>
            <div class="title-block" style="background-color: #900C3F;">X</div>
        </div>

        <!-- ✅ Target Word Display -->
        <div id="target-word-container">
            <div id="target-word-label">TARGET WORD:</div>
            <div id="target-word"></div>
        </div>

        <!-- ✅ Game Grid -->
        <div id="game-grid"></div>

        <!-- ✅ Controls Section -->
        <div id="controls">
            <div id="mobile-controls">
                <button class="mobile-btn" id="left-btn">◀</button>
                <button class="mobile-btn" id="down-btn">▼</button>
                <button class="mobile-btn" id="right-btn">▶</button>
            </div>

            <div id="game-buttons">
                <button class="game-btn" id="start-btn">START</button>
                <button class="game-btn" id="pause-btn">PAUSE</button>
            </div>

            <div id="time-display">
                <div id="timer-container" class="time-container">
                    Time:<br>00:00
                </div>
                <div id="best-time-container" class="time-container">
                    Best Time:<br>--:--
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ Leaderboard Section -->
    <table id="leaderboard">
        <caption>LEADERBOARD</caption>
        <thead>
            <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script type="module">
        document.addEventListener('DOMContentLoaded', async () => {
            const { 
                getFirestore, 
                collection, 
                query, 
                orderBy, 
                limit, 
                onSnapshot
            } = await import("https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js");
            
            const db = getFirestore();
            
            // ✅ Game Variables
            let TARGET_WORD = '';
            let GAME_ID = '';
            const GRID_WIDTH = 8;
            const GRID_HEIGHT = 10;
            const COLORS = ['#2196f3', '#f44336', '#4caf50', '#ffc107', '#9c27b0', '#003366', '#009688'];
            const LETTERS = 'BCDFGHJKLMNPQRSTVWXZ';
            const VOWELS = 'AEIOUY';
            let grid = Array(GRID_HEIGHT).fill().map(() => Array(GRID_WIDTH).fill(null));
            let currentBlock = null;
            let nextBlock = null;
            let gameInterval = null;
            let timerInterval = null;
            let gameTime = 0;
            let isPaused = false;
            let isGameOver = false;
            let isMoving = false;

            // ✅ DOM Elements
            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const leftBtn = document.getElementById('left-btn');
            const downBtn = document.getElementById('down-btn');
            const rightBtn = document.getElementById('right-btn');
            const timerDisplay = document.querySelector('#timer-container');
            const bestTimeDisplay = document.querySelector('#best-time-container');

            // ✅ Initialize Target Word
            async function initializeTargetWord() {
                const gameData = await window.firebaseOps.getGameData();
                if (gameData) {
                    TARGET_WORD = gameData.targetWord;
                    GAME_ID = gameData.id;
                    
                    const targetWordDiv = document.getElementById('target-word');
                    targetWordDiv.innerHTML = '';
                    for (const letter of TARGET_WORD) {
                        const letterDiv = document.createElement('div');
                        letterDiv.className = 'target-letter';
                        letterDiv.textContent = letter;
                        targetWordDiv.appendChild(letterDiv);
                    }
                    
                    setupLeaderboard();
                    return true;
                }
                return false;
            }

            // ✅ Timer Update
            function updateTimer() {
                if (!isPaused && !isGameOver) {
                    gameTime++;
                    timerDisplay.innerHTML = `Time:<br>${formatTime(gameTime)}`;
                }
            }

            // ✅ Initialize Grid
            function initGrid() {
                const gameGrid = document.getElementById('game-grid');
                gameGrid.innerHTML = '';
                grid = Array(GRID_HEIGHT).fill().map(() => Array(GRID_WIDTH).fill(null));
                
                for (let y = 0; y < GRID_HEIGHT; y++) {
                    for (let x = 0; x < GRID_WIDTH; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.setAttribute('data-x', x);
                        cell.setAttribute('data-y', y);
                        gameGrid.appendChild(cell);
                    }
                }
            }

            // ✅ Create Block
            function createBlock() {
                const color = COLORS[Math.floor(Math.random() * COLORS.length)];
                const letter = Math.random() < 0.3 ? 
                    VOWELS[Math.floor(Math.random() * VOWELS.length)] :
                    LETTERS[Math.floor(Math.random() * LETTERS.length)];
                return { color, letter, x: Math.floor(GRID_WIDTH / 2), y: 0 };
            }

            // ✅ Draw Block
            function drawBlock(block) {
                if (!block || block.x < 0 || block.x >= GRID_WIDTH || block.y < 0 || block.y >= GRID_HEIGHT) return;
                const cell = document.querySelector(`#game-grid .grid-cell[data-x="${block.x}"][data-y="${block.y}"]`);
                if (cell) {
                    cell.className = 'grid-cell filled';
                    cell.style.backgroundColor = block.color;
                    cell.textContent = block.letter;
                }
            }

            // ✅ Clear Block
            function clearBlock(block) {
                if (!block || block.x < 0 || block.x >= GRID_WIDTH || block.y < 0 || block.y >= GRID_HEIGHT) return;
                const cell = document.querySelector(`#game-grid .grid-cell[data-x="${block.x}"][data-y="${block.y}"]`);
                if (cell && !grid[block.y][block.x]) {
                    cell.className = 'grid-cell';
                    cell.style.backgroundColor = '';
                    cell.textContent = '';
                }
            }

            // ✅ Check Collision
            function isCollision(block) {
                if (!block) return true;
                if (block.x < 0 || block.x >= GRID_WIDTH) return true;
                if (block.y >= GRID_HEIGHT) return true;
                if (block.y >= 0 && grid[block.y][block.x] !== null) return true;
                return false;
            }

            // ✅ Setup Leaderboard
            function setupLeaderboard() {
                if (!GAME_ID) return;

                const leaderboardQuery = query(
                    collection(db, 'daily_games', GAME_ID, 'leaderboard'),
                    orderBy('time'),
                    limit(10)
                );

                return onSnapshot(leaderboardQuery, (snapshot) => {
                    const tbody = document.querySelector('#leaderboard tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        let rank = 1;
                        
                        if (!snapshot.empty) {
                            const bestTime = snapshot.docs[0].data().time;
                            bestTimeDisplay.innerHTML = `Best Time:<br>${formatTime(bestTime)}`;
                        } else {
                            bestTimeDisplay.innerHTML = 'Best Time:<br>--:--';
                        }

                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${rank}</td>
                                <td>${data.name}</td>
                                <td>${formatTime(data.time)}</td>
                            `;
                            tbody.appendChild(row);
                            rank++;
                        });
                    }
                });
            }
            
            // ✅ Initialize Game
            await initializeTargetWord();
            initGrid();
        });
    </script>
    <!-- ✅ Game Control and Win/Lose Logic -->
    <script type="module">
        function placeBlock() {
            if (!currentBlock || currentBlock.y < 0) return;
            
            grid[currentBlock.y][currentBlock.x] = {
                letter: currentBlock.letter,
                color: currentBlock.color
            };
            
            drawBlock(currentBlock);
            
            if (!checkMatches()) {
                checkWin();
            }
            
            if (nextBlock && isCollision(nextBlock)) {
                endGame('GAME OVER');
                return;
            }
            
            currentBlock = nextBlock;
            nextBlock = createBlock();
            if (currentBlock) drawBlock(currentBlock);
        }

        function dropBlock() {
            if (!currentBlock || isPaused || isGameOver || isMoving) return;
            
            isMoving = true;
            clearBlock(currentBlock);
            
            while (!isCollision({ ...currentBlock, y: currentBlock.y + 1 })) {
                currentBlock.y++;
            }
            
            drawBlock(currentBlock);
            placeBlock();
            isMoving = false;
        }

        function isPartOfTargetWord(letter) {
            return TARGET_WORD.includes(letter);
        }

        function checkAdjacentMatch(x1, y1, x2, y2) {
            const block1 = grid[y1][x1];
            const block2 = grid[y2][x2];
            
            if (!block1 || !block2) return false;
            if (isPartOfTargetWord(block1.letter) || isPartOfTargetWord(block2.letter)) return false;
            
            return block1.color === block2.color || block1.letter === block2.letter;
        }

        function clearCell(x, y) {
            grid[y][x] = null;
            const cell = document.querySelector(`#game-grid .grid-cell[data-x="${x}"][data-y="${y}"]`);
            if (cell) {
                cell.style.transform = 'scale(0)';
                setTimeout(() => {
                    cell.className = 'grid-cell';
                    cell.style.transform = '';
                    cell.style.backgroundColor = '';
                    cell.textContent = '';
                }, 150);
            }
        }

        function checkMatches() {
            const toRemove = new Set();
            
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (!grid[y][x]) continue;
                    
                    if (x < GRID_WIDTH - 1 && checkAdjacentMatch(x, y, x + 1, y)) {
                        toRemove.add(`${x},${y}`);
                        toRemove.add(`${x + 1},${y}`);
                    }
                    
                    if (y < GRID_HEIGHT - 1 && checkAdjacentMatch(x, y, x, y + 1)) {
                        toRemove.add(`${x},${y}`);
                        toRemove.add(`${x},${y + 1}`);
                    }
                }
            }
            
            if (toRemove.size > 0) {
                toRemove.forEach(pos => {
                    const [x, y] = pos.split(',').map(Number);
                    clearCell(x, y);
                });
                setTimeout(() => {
                    shiftDownCells();
                }, 200);
                return true;
            }
            return false;
        }

        function shiftDownCells() {
            let moved;
            do {
                moved = false;
                for (let x = 0; x < GRID_WIDTH; x++) {
                    for (let y = GRID_HEIGHT - 2; y >= 0; y--) {
                        if (grid[y][x] && !grid[y + 1][x]) {
                            grid[y + 1][x] = grid[y][x];
                            grid[y][x] = null;
                            moved = true;
                        }
                    }
                }
                
                for (let x = 0; x < GRID_WIDTH; x++) {
                    for (let y = 0; y < GRID_HEIGHT; y++) {
                        const cell = document.querySelector(`#game-grid .grid-cell[data-x="${x}"][data-y="${y}"]`);
                        if (cell) {
                            if (grid[y][x]) {
                                cell.className = 'grid-cell filled';
                                cell.style.backgroundColor = grid[y][x].color;
                                cell.textContent = grid[y][x].letter;
                            } else {
                                cell.className = 'grid-cell';
                                cell.style.backgroundColor = '';
                                cell.textContent = '';
                            }
                        }
                    }
                }
            } while (moved);
            
            setTimeout(() => {
                if (!checkMatches()) {
                    checkWin();
                }
            }, 100);
        }

        async function checkWin() {
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x <= GRID_WIDTH - TARGET_WORD.length; x++) {
                    let word = '';
                    let isValid = true;
                    let winningCells = [];
                    
                    for (let i = 0; i < TARGET_WORD.length; i++) {
                        if (!grid[y][x + i]) {
                            isValid = false;
                            break;
                        }
                        word += grid[y][x + i].letter;
                        winningCells.push([x + i, y]);
                    }
                    
                    if (isValid && word === TARGET_WORD) {
                        isGameOver = true;
                        clearInterval(gameInterval);
                        clearInterval(timerInterval);
                        
                        winningCells.forEach(([wx, wy]) => {
                            const cell = document.querySelector(`#game-grid .grid-cell[data-x="${wx}"][data-y="${wy}"]`);
                            if (cell) {
                                cell.style.transform = 'scale(1.1)';
                            }
                        });
                        
                        const timeStr = formatTime(gameTime);
                        const message = `YOU DID IT IN ${timeStr}!`;
                        
                        setTimeout(() => {
                            endGame(message, true);
                        }, 500);
                        return;
                    }
                }
            }
        }

        function endGame(message, isWin = false) {
            isGameOver = true;
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            
            const overlay = document.createElement('div');
            overlay.className = 'game-over';
            overlay.innerHTML = `
                <h2>${message}</h2>
                ${isWin ? `
                    <input type="text" id="player-name" maxlength="12" placeholder="Enter your name">
                    <button onclick="submitScore()">Submit Score</button>
                ` : ''}
            `;
            
            document.getElementById('game-grid').appendChild(overlay);
        }
    </script>

    <!-- ✅ Buy Me A Coffee Button -->
    <div class="coffee-button">
        <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
            data-name="bmc-button" data-slug="PlayLeximax" data-color="#FFDD00" data-emoji=""
            data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000"
            data-font-color="#000000" data-coffee-color="#ffffff"></script>
    </div>

    <!-- ✅ Footer Section -->
    <footer>
        <a href="about-leximax.html">About Leximax</a> |
        <a href="privacy-policy.html">Privacy Policy</a> |
        <a href="contact.html">Contact Us</a>
        <p>&copy; 2024 Leximax. All rights reserved.</p>
    </footer>
</body>
</html>
